name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./unit-test-db.sqlite
      JWT_SECRET: test-jwt-unit-$(date +%s)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Run unit tests
      run: |
        echo "üß™ Running unit tests..."
        npm test -- --verbose
      continue-on-error: false

  deploy-stage:
    name: Auto Deploy to Staging
    runs-on: ubuntu-latest
    needs: unit-tests
    if: success()
    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger Staging Deploy
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_STAGING_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
      run: |
        echo "üöÄ Triggering staging deployment..."
        echo "Commit SHA: ${{ github.sha }}"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π –∏ –ù–ï –∂–¥–µ–º –¥–æ–ª–≥–æ
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{}')
        
        status_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "Status: $status_code"
        
        # –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ï –æ–∂–∏–¥–∞–Ω–∏–µ
        if [ "$status_code" = "201" ] || [ "$status_code" = "200" ]; then
          echo "‚úÖ Staging deploy started!"
          sleep 5  # ‚Üê –¢–æ–ª—å–∫–æ 5 —Å–µ–∫—É–Ω–¥!
        else
          echo "‚ö†Ô∏è API: $status_code"
          sleep 3  # ‚Üê –í—Å–µ–≥–æ 3 —Å–µ–∫—É–Ω–¥—ã!
        fi
        
        echo "üéØ Deploy is running. Integration tests can start."

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-stage  # –ñ–¥–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫–∞ –¥–µ–ø–ª–æ—è, –Ω–µ –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    environment: staging
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./integration-test-db.sqlite
      JWT_SECRET: test-jwt-integration-$(date +%s)
      STAGING_URL: ${{ secrets.RENDER_STAGING_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Quick Staging Check (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π)
      run: |
        echo "üîç Quick staging check (non-blocking)..."
        
        # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - 1 –ø–æ–ø—ã—Ç–∫–∞
        http_code=$(curl -s -o /dev/null -w "%{http_code}" \
          --max-time 5 \
          "$STAGING_URL/health" 2>/dev/null || echo "NOT_READY")
        
        echo "Staging health: HTTP $http_code"
        
        if [ "$http_code" = "200" ]; then
          content=$(curl -s --max-time 5 "$STAGING_URL/" 2>/dev/null || echo "NO_CONTENT")
          echo "Current content: $content"
        fi

    - name: Run integration tests
      run: |
        echo "üß™ Running integration tests (LOCAL tests)..."
        echo "These tests use SQLite, NOT staging service"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
        npm run test:integration -- --verbose --detectOpenHandles

  deploy-production:
    name: Auto Deploy to Production
    runs-on: ubuntu-latest
    needs: integration-tests
    if: success()
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger Production Deploy
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_PRODUCTION_SERVICE_ID: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID }}
      run: |
        echo "üöÄ Triggering production deployment..."
        echo "Commit SHA: ${{ github.sha }}"
        
        # –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—Ä–æ—Å
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          "https://api.render.com/v1/services/$RENDER_PRODUCTION_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{}' \
          --max-time 10)  # –¢–∞–π–º–∞—É—Ç 10 —Å–µ–∫—É–Ω–¥
        
        status_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "Status: $status_code"
        
        if [ "$status_code" = "201" ] || [ "$status_code" = "200" ]; then
          echo "‚úÖ Production deploy started!"
          sleep 3  # ‚Üê –¢–æ–ª—å–∫–æ 3 —Å–µ–∫—É–Ω–¥—ã!
        else
          echo "‚ùå Failed: $response_body"
          exit 1
        fi

    - name: Quick Production Check
      env:
        PRODUCTION_URL: ${{ secrets.RENDER_PRODUCTION_URL }}
      run: |
        echo "üîç Quick production check..."
        
        # 1 –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        http_code=$(curl -s -o /dev/null -w "%{http_code}" \
          --max-time 8 \
          "$PRODUCTION_URL/health" 2>/dev/null || echo "DEPLOYING")
        
        echo "Production health: HTTP $http_code"
        
        if [ "$http_code" = "200" ]; then
          echo "‚úÖ Production is up!"
        else
          echo "‚ö†Ô∏è Production still deploying (normal)"
        fi