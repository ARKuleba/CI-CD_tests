name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./unit-test-db.sqlite
      JWT_SECRET: test-jwt-unit-$(date +%s)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Run unit tests
      run: |
        echo "üß™ Running unit tests..."
        npm test -- --verbose
      continue-on-error: false

  deploy-stage:
    name: Auto Deploy to Staging
    runs-on: ubuntu-latest
    needs: unit-tests
    if: success()
    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger Staging Deploy
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_STAGING_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
      run: |
        echo "üöÄ Triggering staging deployment..."
        echo "Commit SHA: ${{ github.sha }}"
        
        # –ü—Ä–æ—Å—Ç–æ–π –≤—ã–∑–æ–≤ API Render
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{}')
        
        status_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "Status code: $status_code"
        echo "Response: $response_body"
        
        if [ "$status_code" = "201" ] || [ "$status_code" = "200" ]; then
          echo "‚úÖ Staging deployment triggered successfully!"
          echo "Waiting for deployment to start (20 seconds)..."
          sleep 20
        else
          echo "‚ö†Ô∏è API returned $status_code"
          echo "Assuming auto-deploy is enabled, waiting for Render..."
          sleep 20
        fi
        
        echo "‚è≥ Additional wait time for build (30 seconds)..."
        sleep 30

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-stage
    environment: staging
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./integration-test-db.sqlite
      JWT_SECRET: test-jwt-integration-$(date +%s)
      STAGING_URL: ${{ secrets.RENDER_STAGING_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Verify Staging is Accessible
      run: |
        echo "üîç Checking if staging is accessible..."
        
        max_attempts=30
        for i in $(seq 1 $max_attempts); do
          echo "Attempt $i/$max_attempts"
          
          # –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 10 \
            "$STAGING_URL/health" 2>/dev/null || echo "000")
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Staging service is healthy (HTTP 200)"
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
            content=$(curl -s --max-time 10 "$STAGING_URL/" 2>/dev/null || echo "UNAVAILABLE")
            echo "üìÑ Current content on staging: $content"
            break
          else
            echo "‚ùå Staging not ready (HTTP $http_code), waiting 10 seconds..."
            if [ $i -lt $max_attempts ]; then
              sleep 10
            fi
          fi
        done
        
        if [ "$http_code" != "200" ]; then
          echo "‚ö†Ô∏è Staging still not ready after $max_attempts attempts"
          echo "Continuing tests anyway..."
        fi

    - name: Run integration tests
      run: |
        echo "üß™ Running integration tests..."
        echo "Test environment will use internal SQLite database"
        echo "Staging URL (for reference): $STAGING_URL"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
        # –û–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î (SQLite)
        npm run test:integration -- --verbose --detectOpenHandles

  deploy-production:
    name: Auto Deploy to Production
    runs-on: ubuntu-latest
    needs: integration-tests
    if: success()
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger Production Deploy
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_PRODUCTION_SERVICE_ID: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID }}
      run: |
        echo "üöÄ Triggering production deployment..."
        echo "Commit SHA: ${{ github.sha }}"
        
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          "https://api.render.com/v1/services/$RENDER_PRODUCTION_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{}')
        
        status_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "Status code: $status_code"
        
        if [ "$status_code" = "201" ] || [ "$status_code" = "200" ]; then
          echo "‚úÖ Production deployment triggered successfully!"
          echo "Response: $response_body"
          
          # –ñ–¥–µ–º –Ω–∞—á–∞–ª–∞ –¥–µ–ø–ª–æ—è
          echo "‚è≥ Waiting for production deployment to start (10 seconds)..."
          sleep 10
        else
          echo "‚ùå Failed to trigger production deploy"
          echo "Response: $response_body"
          exit 1
        fi

    - name: Verify Production Health
      env:
        PRODUCTION_URL: ${{ secrets.RENDER_PRODUCTION_URL }}
      run: |
        echo "üîç Verifying production health..."
        
        max_attempts=20
        for i in $(seq 1 $max_attempts); do
          echo "Attempt $i/$max_attempts"
          
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 15 \
            "$PRODUCTION_URL/health" 2>/dev/null || echo "000")
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Production service is healthy (HTTP 200)"
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            content=$(curl -s --max-time 15 "$PRODUCTION_URL/" 2>/dev/null || echo "UNAVAILABLE")
            echo "üìÑ Production content: $content"
            exit 0
          else
            echo "‚ùå Production not ready (HTTP $http_code), waiting 15 seconds..."
            if [ $i -lt $max_attempts ]; then
              sleep 15
            fi
          fi
        done
        
        echo "‚ö†Ô∏è Production not fully ready after $max_attempts attempts"
        echo "But deployment was triggered successfully."