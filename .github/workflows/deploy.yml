name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./unit-test-db.sqlite
      JWT_SECRET: test-jwt-unit-$(date +%s)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Run unit tests
      run: |
        echo "üß™ Running unit tests..."
        npm test -- --verbose
      continue-on-error: false

  deploy-stage:
    name: Auto Deploy to Staging
    runs-on: ubuntu-latest
    needs: unit-tests
    if: success()
    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug code to deploy
      run: |
        echo "üìå Code being deployed to stage (commit: $(git rev-parse HEAD)):"
        echo "=== server.js content ==="
        cat server.js
        echo "=== package.json ==="
        cat package.json

    - name: Configure Render Auto-Deploy
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_STAGING_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
      run: |
        echo "‚öôÔ∏è Configuring Render for auto-deploy..."
        
        # 1. –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ-–¥–µ–ø–ª–æ–π –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω
        CONFIG_RESPONSE=$(curl -s -w "\n%{http_code}" \
          -X PATCH \
          "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "autoDeploy": "yes",
            "branch": "main"
          }')
        
        CONFIG_BODY=$(echo "$CONFIG_RESPONSE" | head -n -1)
        CONFIG_STATUS=$(echo "$CONFIG_RESPONSE" | tail -n1)
        
        echo "Config response status: $CONFIG_STATUS"
        
        # 2. –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ API (Render —Å–¥–µ–ª–∞–µ—Ç pull –∏–∑ GitHub)
        echo "üöÄ Triggering deploy..."
        DEPLOY_RESPONSE=$(curl -s -w "\n%{http_code}" \
          -X POST \
          "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{}')
        
        DEPLOY_BODY=$(echo "$DEPLOY_RESPONSE" | head -n -1)
        DEPLOY_STATUS=$(echo "$DEPLOY_RESPONSE" | tail -n1)
        
        echo "Deploy response status: $DEPLOY_STATUS"
        echo "Deploy response body: $DEPLOY_BODY"
        
        if [ "$DEPLOY_STATUS" = "201" ] || [ "$DEPLOY_STATUS" = "200" ]; then
          echo "‚úÖ Stage deploy triggered successfully!"
          
          # –ü–æ–ª—É—á–∞–µ–º ID –¥–µ–ø–ª–æ—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
          DEPLOY_ID=$(echo "$DEPLOY_BODY" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "unknown")
          echo "Deploy ID: $DEPLOY_ID"
          
          # –ñ–¥–µ–º –Ω–∞—á–∞–ª–∞ –¥–µ–ø–ª–æ—è
          echo "‚è≥ Waiting 90 seconds for stage deployment..."
          sleep 90
        else
          echo "‚ùå Failed to trigger stage deploy"
          echo "Trying alternative method..."
          
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∞–≤—Ç–æ-–¥–µ–ø–ª–æ–π
          echo "‚ÑπÔ∏è Render service is configured for auto-deploy on push to main"
          echo "Deployment should start automatically..."
          sleep 30
        fi

    - name: Verify Stage Deployment Started
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_STAGING_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
      run: |
        echo "üîç Checking deployment status..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–ø–ª–æ–∏
        DEPLOYS_RESPONSE=$(curl -s \
          "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID/deploys?limit=5" \
          -H "Authorization: Bearer $RENDER_API_KEY")
        
        echo "Recent deploys: $DEPLOYS_RESPONSE"
        
        # –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –¥–µ–ø–ª–æ–π
        if echo "$DEPLOYS_RESPONSE" | grep -q '"status":"queued"\|"status":"building"\|"status":"updating"'; then
          echo "‚úÖ Deployment is in progress!"
        else
          echo "‚ö†Ô∏è No active deployment found. Checking if auto-deploy is enabled..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–∞
          SERVICE_INFO=$(curl -s \
            "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID" \
            -H "Authorization: Bearer $RENDER_API_KEY")
          
          echo "Service info: $SERVICE_INFO"
        fi

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-stage
    environment: staging
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./integration-test-db.sqlite
      JWT_SECRET: test-jwt-integration-$(date +%s)
      STAGING_URL: ${{ secrets.RENDER_STAGING_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Wait for Staging to be ready
      run: |
        echo "‚è≥ Waiting for staging to be ready..."
        
        counter=0
        max_attempts=30
        
        while [ $counter -lt $max_attempts ]; do
          echo "Attempt $((counter + 1))/$max_attempts"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
          health_response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$STAGING_URL/health" 2>/dev/null || echo "000")
          
          if [ "$health_response" = "200" ]; then
            echo "‚úÖ Staging is up (HTTP $health_response)"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–¥–µ–ø–ª–æ–∏–ª—Å—è –Ω–æ–≤—ã–π –∫–æ–¥
            content=$(curl -s --max-time 10 "$STAGING_URL/" 2>/dev/null || echo "CURL_ERROR")
            
            if echo "$content" | grep -q "11111111fghjkl;1"; then
              echo "üéâ SUCCESS! New code detected on staging!"
              echo "Response: $content"
              break
            else
              echo "‚ö†Ô∏è Staging responded but wrong content"
              echo "Got: $content"
              echo "Expected to contain: 11111111fghjkl;1"
            fi
          else
            echo "‚ùå Health check failed (HTTP $health_response), waiting 10 seconds..."
            sleep 10
            counter=$((counter + 1))
          fi
        done
        
        if [ $counter -eq $max_attempts ]; then
          echo "‚ö†Ô∏è Staging not ready after $max_attempts attempts"
          echo "Continuing anyway for integration tests..."
        fi

    - name: Run integration tests
      env:
        STAGING_URL: ${{ secrets.RENDER_STAGING_URL }}
      run: |
        echo "üß™ Running integration tests against staging..."
        echo "Staging URL: $STAGING_URL"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
        npm run test:integration -- --verbose --detectOpenHandles
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ staging
        echo "üß™ Additional staging verification..."
        if [ -n "$STAGING_URL" ]; then
          staging_check=$(curl -s --max-time 10 "$STAGING_URL/" || echo "UNAVAILABLE")
          echo "Final staging check: $staging_check"
        fi

  deploy-production:
    name: Auto Deploy to Production
    runs-on: ubuntu-latest
    needs: integration-tests
    if: success()
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug production code
      run: |
        echo "üìå Code being deployed to production:"
        echo "Commit: $(git rev-parse HEAD)"
        echo "Server.js first lines:"
        head -5 server.js

    - name: Trigger Production Deploy
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_PRODUCTION_SERVICE_ID: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID }}
      run: |
        echo "üöÄ Triggering production deploy..."
        
        # –ú–µ—Ç–æ–¥ 1: –ü—Ä—è–º–æ–π API –≤—ã–∑–æ–≤
        DEPLOY_RESPONSE=$(curl -s -w "\n%{http_code}" \
          -X POST \
          "https://api.render.com/v1/services/$RENDER_PRODUCTION_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"clearCache": true}')
        
        DEPLOY_BODY=$(echo "$DEPLOY_RESPONSE" | head -n -1)
        DEPLOY_STATUS=$(echo "$DEPLOY_RESPONSE" | tail -n1)
        
        echo "Deploy response status: $DEPLOY_STATUS"
        
        if [ "$DEPLOY_STATUS" = "201" ] || [ "$DEPLOY_STATUS" = "200" ]; then
          echo "‚úÖ Production deploy triggered!"
          echo "Response: $DEPLOY_BODY"
          
          DEPLOY_ID=$(echo "$DEPLOY_BODY" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "unknown")
          echo "Deploy ID: $DEPLOY_ID"
          
          # –ñ–¥–µ–º
          echo "‚è≥ Waiting 120 seconds for production deployment..."
          sleep 120
        else
          echo "‚ùå Method 1 failed: HTTP $DEPLOY_STATUS"
          echo "Trying method 2..."
          
          # –ú–µ—Ç–æ–¥ 2: –ü—É—Å—Ç–æ–π JSON
          DEPLOY_RESPONSE2=$(curl -s -w "\n%{http_code}" \
            -X POST \
            "https://api.render.com/v1/services/$RENDER_PRODUCTION_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{}')
          
          DEPLOY_STATUS2=$(echo "$DEPLOY_RESPONSE2" | tail -n1)
          
          if [ "$DEPLOY_STATUS2" = "201" ] || [ "$DEPLOY_STATUS2" = "200" ]; then
            echo "‚úÖ Production deploy triggered (method 2)!"
            sleep 120
          else
            echo "‚ùå All methods failed"
            echo "Please check:"
            echo "1. RENDER_PRODUCTION_SERVICE_ID is correct"
            echo "2. API key has permissions"
            echo "3. Service exists in Render"
            exit 1
          fi
        fi

    - name: Verify Production Deployment
      env:
        PRODUCTION_URL: ${{ secrets.RENDER_PRODUCTION_URL }}
      run: |
        echo "üß™ Verifying Production..."
        echo "URL: $PRODUCTION_URL"
        
        counter=0
        max_attempts=25
        
        while [ $counter -lt $max_attempts ]; do
          echo "Attempt $((counter + 1))/$max_attempts"
          
          health_response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$PRODUCTION_URL/health" 2>/dev/null || echo "000")
          
          if [ "$health_response" = "200" ]; then
            echo "‚úÖ Production health check passed"
            
            content=$(curl -s --max-time 10 "$PRODUCTION_URL/" 2>/dev/null || echo "UNAVAILABLE")
            
            if echo "$content" | grep -q "11111111fghjkl;1"; then
              echo "üéâ PRODUCTION SUCCESS! New code deployed!"
              echo "Response: $content"
              exit 0
            else
              echo "‚ö†Ô∏è Production up but wrong content"
              echo "Got: $content"
              exit 1
            fi
          fi
          
          echo "‚è≥ Waiting 15 seconds..."
          sleep 15
          counter=$((counter + 1))
        done
        
        echo "‚ö†Ô∏è Production verification timeout"
        exit 1