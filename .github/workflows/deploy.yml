name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch: # –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –¥–µ–ø–ª–æ–µ–≤

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./unit-test-db.sqlite
      JWT_SECRET: test-jwt-unit-$(date +%s)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: |
        npm ci
        echo "‚úÖ Dependencies installed"

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Run unit tests
      run: |
        echo "üß™ Running unit tests..."
        npm test -- --verbose
      continue-on-error: false

  stage:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: unit-tests
    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Staging (Render)
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_STAGING_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
      run: |
        echo "üöÄ Deploying to Staging on Render..."
        curl -X POST \
          "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"clearCache": true}'
        echo "‚úÖ Staging deployment triggered"

    - name: Wait for staging deployment
      run: |
        echo "‚è≥ Waiting 30 seconds for deployment..."
        sleep 30

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: stage
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./integration-test-db.sqlite
      JWT_SECRET: test-jwt-integration-$(date +%s)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: npm ci

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Run integration tests
      run: |
        echo "üß™ Running integration tests..."
        echo "Using SQLite database: $DB_STORAGE"
        npm run test:integration -- --verbose --detectOpenHandles
      continue-on-error: false

    - name: Smoke test Staging
      if: success()
      env:
        STAGING_URL: ${{ secrets.RENDER_STAGING_URL }}
      run: |
        echo "üß™ Testing Staging Environment..."
        echo "Staging URL: $STAGING_URL"
        
        response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$STAGING_URL/health" || echo "000")
        
        if [ "$response" = "200" ]; then
          echo "‚úÖ Staging is up and running (HTTP $response)"
        else
          echo "‚ö†Ô∏è Staging health check failed: HTTP $response"
        fi

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: integration-tests
    environment: production
    if: github.event_name == 'workflow_dispatch'  # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫!

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Production (Render)
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_PRODUCTION_SERVICE_ID: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID }}
      run: |
        echo "üöÄ Deploying to Production on Render..."
        curl -X POST \
          "https://api.render.com/v1/services/$RENDER_PRODUCTION_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"clearCache": true}'
        echo "‚úÖ Production deployment triggered"

    - name: Wait for production deployment
      run: |
        echo "‚è≥ Waiting 30 seconds for deployment..."
        sleep 30

    - name: Smoke test Production
      if: success()
      env:
        PRODUCTION_URL: ${{ secrets.RENDER_PRODUCTION_URL }}
      run: |
        echo "üß™ Testing Production Environment..."
        echo "Production URL: $PRODUCTION_URL"
        
        counter=0
        max_attempts=10
        
        while [ $counter -lt $max_attempts ]; do
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$PRODUCTION_URL/health" || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ Production is up and running (HTTP $response)"
            exit 0
          else
            echo "‚è≥ Attempt $((counter + 1))/$max_attempts - Health check failed (HTTP $response)"
            sleep 10
            counter=$((counter + 1))
          fi
        done
        
        echo "‚ö†Ô∏è Production health check failed after $max_attempts attempts"