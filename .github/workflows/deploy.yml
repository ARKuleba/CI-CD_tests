name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./unit-test-db.sqlite
      JWT_SECRET: test-jwt-unit-$(date +%s)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Run unit tests
      run: |
        echo "üß™ Running unit tests..."
        npm test -- --verbose
      continue-on-error: false

  deploy-stage:
    name: Auto Deploy to Staging
    runs-on: ubuntu-latest
    needs: unit-tests
    if: success()
    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger Staging Deploy
      id: trigger-deploy
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_STAGING_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
      run: |
        echo "üöÄ Triggering staging deployment..."
        
        # 1. –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π –∏ –ø–æ–ª—É—á–∞–µ–º ID –¥–µ–ø–ª–æ—è
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{}')
        
        status_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "Status: $status_code"
        
        if [ "$status_code" = "201" ] || [ "$status_code" = "200" ]; then
          # 2. –ò–∑–≤–ª–µ–∫–∞–µ–º ID –¥–µ–ø–ª–æ—è –∏–∑ –æ—Ç–≤–µ—Ç–∞
          deploy_id=$(echo "$response_body" | jq -r '.id // empty')
          if [ -n "$deploy_id" ]; then
            echo "‚úÖ Staging deploy started! Deploy ID: $deploy_id"
            echo "deploy_id=$deploy_id" >> $GITHUB_OUTPUT
            
            # 3. –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è
            echo "‚è≥ Waiting for deploy to complete..."
            timeout=600  # 10 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º
            interval=10  # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            elapsed=0
            
            while [ $elapsed -lt $timeout ]; do
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è
              deploy_status=$(curl -s \
                "https://api.render.com/v1/services/$RENDER_STAGING_SERVICE_ID/deploys/$deploy_id" \
                -H "Authorization: Bearer $RENDER_API_KEY" | jq -r '.status // "unknown"')
              
              echo "Deploy status: $deploy_status ($elapsed/$timeout seconds)"
              
              if [ "$deploy_status" = "live" ]; then
                echo "‚úÖ Deploy completed successfully!"
                echo "deploy_completed=true" >> $GITHUB_OUTPUT
                break
              elif [ "$deploy_status" = "failed" ] || [ "$deploy_status" = "canceled" ]; then
                echo "‚ùå Deploy failed with status: $deploy_status"
                exit 1
              fi
              
              sleep $interval
              elapsed=$((elapsed + interval))
            done
            
            if [ $elapsed -ge $timeout ]; then
              echo "‚ùå Deploy timeout after $timeout seconds"
              exit 1
            fi
          else
            echo "‚ùå Could not get deploy ID from response"
            exit 1
          fi
        else
          echo "‚ùå Failed to trigger deploy: $status_code"
          echo "Response: $response_body"
          exit 1
        fi

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: [deploy-stage]  # –¢–µ–ø–µ—Ä—å –∂–¥–µ–º –ó–ê–í–ï–†–®–ï–ù–ò–Ø –¥–µ–ø–ª–æ—è
    environment: staging
    
    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ./integration-test-db.sqlite
      JWT_SECRET: test-jwt-integration-$(date +%s)
      STAGING_URL: ${{ secrets.RENDER_STAGING_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test database
      run: |
        touch $DB_STORAGE
        echo "üìÅ Database file: $DB_STORAGE"

    - name: Wait for Staging to be Ready
      run: |
        echo "üîç Waiting for staging to be ready..."
        timeout=120
        interval=5
        elapsed=0
        
        while [ $elapsed -lt $timeout ]; do
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 5 \
            "$STAGING_URL/health" 2>/dev/null || echo "NOT_READY")
          
          echo "Health check: HTTP $http_code ($elapsed/$timeout seconds)"
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Staging is ready!"
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API
            api_status=$(curl -s --max-time 5 "$STAGING_URL/api/health" 2>/dev/null || echo "{}")
            echo "API status: $api_status"
            break
          fi
          
          sleep $interval
          elapsed=$((elapsed + interval))
        done
        
        if [ $elapsed -ge $timeout ]; then
          echo "‚ùå Staging not ready after $timeout seconds"
          exit 1
        fi

    - name: Run integration tests
      run: |
        echo "üß™ Running integration tests..."
        echo "Testing against: $STAGING_URL"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º integration —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ç–∏–≤ staging –æ–∫—Ä—É–∂–µ–Ω–∏—è
        npm run test:integration -- --verbose --detectOpenHandles

  deploy-production:
    name: Auto Deploy to Production
    runs-on: ubuntu-latest
    needs: [integration-tests]  # –ñ–¥–µ–º —É—Å–ø–µ—à–Ω—ã—Ö integration —Ç–µ—Å—Ç–æ–≤
    if: success()
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Trigger and Wait for Production Deploy
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_PRODUCTION_SERVICE_ID: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID }}
      run: |
        echo "üöÄ Triggering production deployment..."
        
        # 1. –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π
        response=$(curl -s -w "\n%{http_code}" \
          -X POST \
          "https://api.render.com/v1/services/$RENDER_PRODUCTION_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{}')
        
        status_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "Status: $status_code"
        
        if [ "$status_code" = "201" ] || [ "$status_code" = "200" ]; then
          # 2. –ò–∑–≤–ª–µ–∫–∞–µ–º ID –¥–µ–ø–ª–æ—è
          deploy_id=$(echo "$response_body" | jq -r '.id // empty')
          
          if [ -n "$deploy_id" ]; then
            echo "‚úÖ Production deploy started! Deploy ID: $deploy_id"
            
            # 3. –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è
            echo "‚è≥ Waiting for production deploy to complete..."
            timeout=900  # 15 –º–∏–Ω—É—Ç –¥–ª—è production
            interval=15
            elapsed=0
            
            while [ $elapsed -lt $timeout ]; do
              deploy_status=$(curl -s \
                "https://api.render.com/v1/services/$RENDER_PRODUCTION_SERVICE_ID/deploys/$deploy_id" \
                -H "Authorization: Bearer $RENDER_API_KEY" | jq -r '.status // "unknown"')
              
              echo "Deploy status: $deploy_status ($elapsed/$timeout seconds)"
              
              if [ "$deploy_status" = "live" ]; then
                echo "‚úÖ Production deploy completed successfully!"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
                sleep 10
                http_code=$(curl -s -o /dev/null -w "%{http_code}" \
                  --max-time 10 \
                  "${{ secrets.RENDER_PRODUCTION_URL }}/health" 2>/dev/null || echo "CHECKING")
                
                echo "Production health: HTTP $http_code"
                break
                
              elif [ "$deploy_status" = "failed" ] || [ "$deploy_status" = "canceled" ]; then
                echo "‚ùå Production deploy failed: $deploy_status"
                
                # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
                deploy_details=$(curl -s \
                  "https://api.render.com/v1/services/$RENDER_PRODUCTION_SERVICE_ID/deploys/$deploy_id" \
                  -H "Authorization: Bearer $RENDER_API_KEY")
                echo "Error details: $deploy_details"
                exit 1
              fi
              
              sleep $interval
              elapsed=$((elapsed + interval))
            done
            
            if [ $elapsed -ge $timeout ]; then
              echo "‚ùå Production deploy timeout"
              exit 1
            fi
          else
            echo "‚ùå Could not get deploy ID"
            exit 1
          fi
        else
          echo "‚ùå Failed to trigger production deploy: $status_code"
          exit 1
        fi

    - name: Verify Production
      env:
        PRODUCTION_URL: ${{ secrets.RENDER_PRODUCTION_URL }}
      run: |
        echo "üîç Final production verification..."
        
        # –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–æ–∫
        for i in {1..5}; do
          echo "Attempt $i/5..."
          
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 10 \
            "$PRODUCTION_URL/health")
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Production verified successfully!"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            curl -s --max-time 10 "$PRODUCTION_URL/" | head -100
            exit 0
          fi
          
          sleep 5
        done
        
        echo "‚ùå Production verification failed"
        exit 1